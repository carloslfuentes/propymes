%section#content
  .wrapper
    %section.grid_2.first
      %h4
        ="Medico: #{current_user.login}"
      .columns
        =@cite.errors.full_messages if @cite.errors.present?
        .grid_2.first
          %fieldset.panel
            = form_for @cite do |f|
              .clearfix
                =f.label :user_id
                =f.collection_select :user_id, User.only_medic.sort_by(&:login), :id, :login, {:include_blank => '',:selected=>current_user.id}
              .clearfix
                =f.label :patient_id
                =f.collection_select :patient_id, Patient.for_user_medic(current_user.id).sort_by(&:name), :id, :name, {}
              .clearfix.al.start_date
                = f.label :date_cite
              .clearfix.al
                = f.text_field :date_cite, :id => "publication_date", :style => "width:100px;", :class => "publication_date", :readonly => true
              .clearfix
                =f.label :custom_period_time
                =f.hidden_field :custom_period_time
              %table.sortable
                %tr
                  %td{:style => "text-align:center;"}
                    ="Hour"
                  %td{:style => "text-align:center;"}
                    = text_field_tag :hour, nil, "type_field"=>"23", :style => "width:25px;", :class=>"numeric",:maxlength=>2
                  %td{:style => "text-align:center;"}
                    ="Minuts"
                  %td{:style => "text-align:center;"}
                    =":"
                  %td{:style => "text-align:center;"}
                    = text_field_tag :minut, nil, "type_field"=>"59",:style => "width:25px;", :class=>"numeric"
              .clearfix
                ="Description"
              %br
                = f.text_area :description, :style => "width:200px;height:100px"
              .clearfix
              %button.button.button-blue.white{:type => "submit", :onclick=>"addTimeToDate();"}
                = t :save
              =link_to "atras", patients_path, :class=>"button button-red"
:javascript
  function addTimeToDate(){
    var dateTime = $("#publication_date").val() + " " + $("#hour").val() + ":" + $("#minut").val(); 
    $("#publication_date").val(dateTime);
  }
  $(document).ready(function() {
    $("#cite_user_id").change(function() {
      $.get("/patients/get_patient_for_medic",{user_id: $(this).find("option:selected").val()}).done(function(data){
        document.getElementById("cite_patient_id").innerHTML = "";
        if(data){
          $("#cite_patient_id").append('<option></option>');
          $.each(data,function(id,name){
            $.each(name,function(key,val){
              $("#cite_patient_id").append('<option value="' + val[1] +'">' + val[0] + '</option>');
            });
          });
        }
      });
    });
    $(".numeric").keyup(function () { 
        this.value = this.value.replace(/[^0-9\.]/g,'');
        var max_time = parseInt(this.getAttribute("type_field"))
        if(parseInt(this.value) > max_time){
          this.value = max_time
        }
    });
    var myCalendar;
    myCalendar = new dhtmlXCalendarObject(["publication_date"]);
    //myCalendar.setDateFormat("#{t('date.formats.dhtmlx')}");
    $(".dhtmlxcalendar_container").css('z-index', '9999') ;
  });